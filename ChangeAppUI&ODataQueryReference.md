# Change your App UI and get an idea of the used OData query code

* [Replace generated UI code with your own](#changeui)
* [OData Query Examples](#queries)
    * [Getting a list of reports](#getlist)
    * [Getting the list of expenses for a report](#getexpenses)
    * [Creating a new expense](#createexpense)
    * [Attach a receipt to an expense](#attachReceipt)
    * [Updating an existing expense](#updateexpense)
    * [Deleting an existing expense](#deleteexpense)
    * [Submitting a report](#submitreport)

<a name="changeui"/>

## Replace generated UI code with your own

Now that you have your app generated you can run it. You will see a more or less satifying UI but what you really want is replace that UI with your own creative UI.

![combined](https://user-images.githubusercontent.com/9074514/59393799-ec5de080-8d31-11e9-930f-19eb04688710.png)

To implement your own UI you have to do some minor changes in the generated code. In your project you can see that there is a **ViewControllers** group which contains all generated UIViewController code. You could delete this folder but for this workshop we just leave it as it is to use it as a reference for OData backend calls.

![xcode-1](https://user-images.githubusercontent.com/9074514/59393925-7c9c2580-8d32-11e9-9c27-6c2e68c6537b.png)

In order to implement your own UI please go to the Main.storyboard file and delete all views defined in the storyboard. 

![xcode-storyboard-1](https://user-images.githubusercontent.com/9074514/59394220-b4579d00-8d33-11e9-9c80-2e62b510bc1f.png)

Now add a new UIViewController from the Object library. Select the added UIViewController and on the right-hand side click on the Attributes Inspector. In the Attributes Inspector check the **Is Initial View Controller**. The added UIViewController is now your initial view controller.

![xcode-storyboard-2](https://user-images.githubusercontent.com/9074514/59394221-b4579d00-8d33-11e9-9cb4-698b6ef4f791.png)

The view controller needs a UIViewController class to back the UI up. Please create a new UIViewController class and name it **MainViewController**.

![xcode-vc-1](https://user-images.githubusercontent.com/9074514/59394463-963e6c80-8d34-11e9-9937-e788f858dea0.png)

Go back to the Main.storyboard and select your view controller. In the Identity Inspector set the class to **MainViewController** and hit return. You now connected the visual representation in storyboard to a Swift class.

![xcode-vc-2](https://user-images.githubusercontent.com/9074514/59394464-963e6c80-8d34-11e9-9e8d-03f666fca7d2.png)

Last step is to change the code in the **ApplicationUIManager.swift** class to initialize the new view controller instead of the generated view code.

Open the **ApplicationUIManager.swift** file.

![xcode-2](https://user-images.githubusercontent.com/9074514/59394562-f2a18c00-8d34-11e9-814f-17ba4918f443.png)

Search for **splitViewController**.

![xcode-3](https://user-images.githubusercontent.com/9074514/59394564-f46b4f80-8d34-11e9-9829-2ec896a73f55.png)

What this code does is initializing the generated code from the Main.storyboard and set it as initial view controller. Change the following code:

```swift
   let appDelegate = (UIApplication.shared.delegate as! AppDelegate)
            let splitViewController = UIStoryboard(name: "Main", bundle: Bundle.main).instantiateViewController(withIdentifier: "MainSplitViewController") as! UISplitViewController
            splitViewController.delegate = appDelegate
            splitViewController.modalPresentationStyle = .currentContext
            splitViewController.preferredDisplayMode = .allVisible
            appViewController = splitViewController

```

to

```swift
let mainViewController = UIStoryboard(name: "Main", bundle: Bundle.main).instantiateInitialViewController() as! MainViewController
            mainViewController.modalPresentationStyle = .currentContext
            appViewController = mainViewController

```

If you run the app now you should just see a white screen instead of the generated UI. To actually see something please go back to the Main.storyboard and add a UILabel to the view.

![add-label-1](https://user-images.githubusercontent.com/9074514/59394784-e669fe80-8d35-11e9-84ba-025fb3d1cb3d.png)

Run the app and you should see your added label appear on the screen.

![add-label-2](https://user-images.githubusercontent.com/9074514/59394785-e669fe80-8d35-11e9-92c4-b1622d9b68cf.png)

Congratulations! You just replaced the generated UI with your own. You have the perfect starting point now to be creative for your own Travel Expense app.

<a name="queries"/>

## OData Query Examples

This guide contains example code for you to get started with writing your own queries for the Travel Expense service.

The `dataService` in each example is expected to be the sample Travel Expense service. In an app generated by the Assistant, this is exposed as a property on the `ODataController` which can be accessed over the `AppDelegate` class. To access this more conveniently, the following lines can be placed at the top of your view controller classes:

```swift
guard let travelexpenseService = appDelegate.sessionManager.onboardingSession?.odataController.travelexpenseService else {
            AlertHelper.displayAlert(with: "OData service is not reachable, please onboard again.", error: nil, viewController: self)
            return
        }
self.travelexpenseService = travelexpenseService
```

The code in each of these examples can be used with any of the proxy classes. The data service provides `fetch` methods for each type, and any proxy class instance can be passed into the `createEntity`, `updateEntity`, and/or `deleteEntity` methods.

If you're interested on exploring the service through your browser you can do this as like this:

- ServiceDocument: https://iosworkshop2019.cfapps.eu10.hana.ondemand.com/
- MetadataDocument: https://iosworkshop2019.cfapps.eu10.hana.ondemand.com/$metadata
- Reports: https://iosworkshop2019.cfapps.eu10.hana.ondemand.com/ReportSet
- Report with id 1: https://iosworkshop2019.cfapps.eu10.hana.ondemand.com/ReportSet(1)

You can do this with all the entities in the service.

<a name="getlist"/>

### Getting a list of reports

* Assume a property called `reports` of type `[Report]`.

```swift
// Order the results by the end date of the expense report, descending.
// Expand the query to also get the associated Report Status.
let query = DataQuery().orderBy(Report.end, .descending).expand(Report.reportStatus)

// Fetch all expense reports, using the query parameters defined above.
travelexpenseService?.fetchReportSet(matching: query) { [weak self] reports, error in
   if let error = error {
      NSLog("Error: %@", error!.localizedDescription)
      return
   }
   self?.reports = reports!
   self?.tableView.reloadData()
}
```

<a name="getexpenses">
   
### Getting the list of expenses for a report

When displaying the details for a selected report, you will likely want to display the list of associated expense items.

* Assume a property called `report` of type `Report`.
* Assume a property called `expenses` of type `[Expense]`.

```swift
// Filter the results by the selected report ID, automatically retrieving
// associated records for the expense type, attachments, currencies and ordering
// by the expense date, ascending.
let reportID = report.reportid!
let query = DataQuery().filter(Expense.reportID == reportID)
            .expand(Expense.expenseType, Expense.attachments, Expense.currency)
            .orderBy(Expense.date)
            
// Fetch all expense items, using the query parameters defined above.
travelexpenseService?.fetchExpenseSet(matching: query) { [weak self] expenses, error in
   // Make sure no errors occurred.
   if let error = error {
      NSLog("Error: %@", error!.localizedDescription)
      return
   }
   self?.expenses = expenses!
   self?.tableView.reloadData()
}
```

<a name="createexpense">
   
### Creating a new expense

* Assume a property called `report` of type `Report`.
* Assume a property called `newExpense` of type `Expense`.
* Assume there is a selected currency, payment type and expense type called `selectedCurrency`, `selectedPaymentType`, `selectedExpenseType`.
* Assume the properties of `newExpense` have been filled in from the UI.

```swift
let newExpense = Expense()
// Fill the expense properties

// Setting the corresponding IDs which are needed to make references to the navigation link properties
newExpense.reportID = reportID
newExpense.currencyID = selectedCurrency?.currencyID
newExpense.paymentTypeID = selectedPaymentType?.paymentTypeID
newExpense.expenseTypeID = selectedExpenseType?.expenseTypeID

travelexpenseService.createEntity(newExpense) {[weak self] error in
   if let error = error {
      NSLog("Error: %@", error.localizedDescription)
   }
   self?.tableView.reloadData()
}
```

<a name="attachReceipt">

### Attach a receipt to an expense

* Assume a property called `existingExpense` of type `Expense`.
* Assume the properties of `existingExpense` are already set and you want to attach an image.
* Assume the attachments are hold in an array of file URLs pointing to the taken pictures.

```swift
// Create the image data and add it to the newExpense object.
let imageData = try? Data(contentsOf: url)
let attachment = Attachment(withDefaults: false)
attachment.image = imageData

newExpense.attachments = [attachment]
            
travelexpenseService.createEntity(newExpense) {[weak self] error in
   if let error = error {
       AlertHelper.displayAlert(with: "Could not create Expense", error: error, viewController: self)
   }
   self?.tableView.reloadData()
}


```

<a name="updateexpense">
   
### Updating an existing expense

* Assume a property called `existingExpense` of type `Expense`.

```swift
dataService.updateEntity(existingExpense) {[weak self] error in
    // Make sure no errors occurred.
    if let error = error {
        NSLog("Error: %@", error.localizedDescription)
    }
    self?.tableView.reloadData()
}
```

<a name="deleteexpense">
   
### Deleting an existing expense

* Assume a property called `existingExpense` of type `Expense`.

```swift
dataService.deleteEntity(existingExpense) {[weak self] error in
    // Make sure no errors occurred.
    if let error = error {
        NSLog("Error: %@", error.localizedDescription)
    }
    self?.tableView.reloadData()
}
```

<a name="submitreport">

### Submitting a report

* Assume a property called `openReport` of type `Report`.
* Assume the id of the `In Review` report status is `2`.

Setting the `reportStatusID` to `2` will set the status of the report from `Open` to `In Review`. This is considered as submitting a report.

```swift
report.reportStatusID = 2

travelexpenseService.updateEntity(report) { [weak self] error in
   // Make sure no errors occurred.
    if let error = error {
        NSLog("Error: %@", error.localizedDescription)
    }
    self?.tableView.reloadData()
 }

```


